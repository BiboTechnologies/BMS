<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>Bambi Hospital - Admin Panel</title>
  <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css'>
<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/gentelella/1.3.0/css/custom.css'>
<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css'><link rel="stylesheet" href="./portal.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.0.2/js/bootstrap.bundle.min.js"></script>
</head>

<!-- partial:index.partial.html -->
<body class="nav-md">

<div class="container body">
  <div class="main_container">
    <div class="col-md-3 left_col">
      <div class="left_col scroll-view">
        <div class="navbar nav_title" style="border: 0;">
          <a href="index.html" class="site_title">
            <img class="dashImg" src="BMS logo only.png" alt="Dashboard Image">
            <span>BIBO MEDSYS</span>
        </a>
              </div>

        <div class="clearfix"></div>

        <!-- menu profile quick info -->
        <div class="profile clearfix">
          <div class="profile_pic">
            <img src="./sanyuweb-main/img/about.jpg" alt="..." class="img-circle profile_img">
          </div>
          <div class="profile_info">
            <span>Welcome,</span>
            <h2>Doctor Jombwe</h2>
          </div>
        </div>
        <!-- /menu profile quick info -->

        <br />

        <!-- sidebar menu -->
        <div id="sidebar-menu" class="main_menu_side hidden-print main_menu">
          <div class="menu_section">
            <h3>General</h3>
            <ul class="nav side-menu">
              <li><a><i class="fa fa-home"></i> Home <span class="fa fa-chevron-down"></span></a>
                <ul class="nav child_menu">
                  <li><a href="portal.html">Dashboard</a></li>
            <!--     <li><a href="index2.html">Dashboard2</a></li>
                  <li><a href="index3.html">Dashboard3</a></li>--> 
                </ul>
              </li>
              <li><a><i class="fa fa-edit"></i>Management <span class="fa fa-chevron-down"></span></a>
                <ul class="nav child_menu">
                  <li><a href="patients.html">All Patients</a></li>
                 <li><a href="staff.html">Hospital Staff</a></li>
                 <!--   <li><a href="form_validation.html">Form Validation</a></li>
                 <li><a href="form_wizards.html">Form Wizard</a></li>
                  <li><a href="form_upload.html">Form Upload</a></li>
                  <li><a href="form_buttons.html">Form Buttons</a></li>-->
                </ul>
              </li>
              <li><a><i class="fa fa-medkit"></i>Medicine<span class="fa fa-chevron-down"></span></a>
                <ul class="nav child_menu">
                 <li><a href="medicines.html">All Medicines</a></li>
                <!--   <li><a href="media_gallery.html">Media Gallery</a></li>
                  <li><a href="typography.html">Typography</a></li>
                  <li><a href="icons.html">Icons</a></li>
                  <li><a href="glyphicons.html">Glyphicons</a></li>
                  <li><a href="widgets.html">Widgets</a></li>
                  <li><a href="invoice.html">Invoice</a></li>
                  <li><a href="inbox.html">Inbox</a></li>
                  <li><a href="calendar.html">Calendar</a></li>-->
                </ul>
              </li>
              <!-- <li><a><i class="fa fa-table"></i> Tables <span class="fa fa-chevron-down"></span></a>
              <ul class="nav child_menu">
                  <li><a href="tables.html">Tables</a></li>
                  <li><a href="tables_dynamic.html">Table Dynamic</a></li>
                </ul>--> 
              </li>
              <li><a><i class="fa fa-bar-chart-o"></i> Data Analytics <span class="fa fa-chevron-down"></span></a>
                <ul class="nav child_menu">
                  <li><a href="revenue.html">Sales and Revenue</a></li>
                 <li><a href="progress.html">Revenue Progress</a></li>
               <!--    <li><a href="morisjs.html">Moris JS</a></li>
                  <li><a href="echarts.html">ECharts</a></li>
                  <li><a href="other_charts.html">Other Charts</a></li>
                </ul>
              </li>
              <li><a><i class="fa fa-clone"></i>Layouts <span class="fa fa-chevron-down"></span></a>
                <ul class="nav child_menu">
                  <li><a href="fixed_sidebar.html">Fixed Sidebar</a></li>
               <li><a href="fixed_footer.html">Fixed Footer</a></li>-->
                </ul>
              </li>
            </ul>
          </div>
       <div class="menu_section">
            <ul class="nav side-menu">
             <!--   <li><a><i class="fa fa-bug"></i> Additional Pages <span class="fa fa-chevron-down"></span></a>
               <ul class="nav child_menu">
                  <li><a href="e_commerce.html">E-commerce</a></li>
                  <li><a href="projects.html">Projects</a></li>
                  <li><a href="project_detail.html">Project Detail</a></li>
                  <li><a href="contacts.html">Contacts</a></li>
                  <li><a href="profile.html">Profile</a></li>
                </ul>
              </li>
              <li><a><i class="fa fa-windows"></i> Extras <span class="fa fa-chevron-down"></span></a>
                <ul class="nav child_menu">
                  <li><a href="page_403.html">403 Error</a></li>
                  <li><a href="page_404.html">404 Error</a></li>
                  <li><a href="page_500.html">500 Error</a></li>
                  <li><a href="plain_page.html">Plain Page</a></li>
                  <li><a href="login.html">Login Page</a></li>
                  <li><a href="pricing_tables.html">Pricing Tables</a></li>
                </ul>
              </li>
              <li><a><i class="fa fa-sitemap"></i> Multilevel Menu <span class="fa fa-chevron-down"></span></a>
                <ul class="nav child_menu">
                  <li><a href="#level1_1">Level One</a>
                    <li><a>Level One<span class="fa fa-chevron-down"></span></a>
                      <ul class="nav child_menu">
                        <li class="sub_menu"><a href="level2.html">Level Two</a>
                        </li>
                        <li><a href="#level2_1">Level Two</a>
                        </li>
                        <li><a href="#level2_2">Level Two</a>
                        </li>
                      </ul>
                    </li>
                    <li><a href="#level1_2">Level One</a>
                    </li>
                </ul>
                </li>
                <li><a href="javascript:void(0)"><i class="fa fa-laptop"></i> Landing Page <span class="label label-success pull-right">Coming Soon</span></a></li>
            </ul>-->
          </div>

        </div>
        <!-- /sidebar menu -->

        <!-- /menu footer buttons -->
        <div class="sidebar-footer hidden-small">
          <a data-toggle="tooltip" data-placement="top" title="Settings">
            <span class="glyphicon glyphicon-cog" aria-hidden="true"></span>
          </a>
          <a data-toggle="tooltip" data-placement="top" title="FullScreen">
            <span class="glyphicon glyphicon-fullscreen" aria-hidden="true"></span>
          </a>
          <a data-toggle="tooltip" data-placement="top" title="Lock">
            <span class="glyphicon glyphicon-eye-close" aria-hidden="true"></span>
          </a>
          <a data-toggle="tooltip" data-placement="top" title="Logout" href="login.html">
            <span class="glyphicon glyphicon-off" aria-hidden="true"></span>
          </a>
        </div>
        <!-- /menu footer buttons -->
      </div>
    </div>

    <!-- top navigation -->
    <div class="top_nav">
      <div class="nav_menu">
        <nav> 
          <div class="nav toggle">
            <a id="menu_toggle"><i class="fa fa-bars"></i></a>
          </div>

          <ul class="nav navbar-nav navbar-right">
            <li class="">
              <a href="javascript:;" class="user-profile dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                <img src="./sanyuweb-main/img/about.jpg" alt="">Dr. Jombwe
                <span class=" fa fa-angle-down"></span>
              </a>
              <ul class="dropdown-menu dropdown-usermenu pull-right">
                <li><a href="javascript:;"> Profile</a></li>
                <li>
                  <a href="javascript:;">
                    <span class="badge bg-red pull-right">50%</span>
                    <span>Settings</span>
                  </a>
                </li>
                <li><a href="javascript:;">Help</a></li>
                <li><a href="login.html"><i class="fa fa-sign-out pull-right"></i> Log Out</a></li>
              </ul>
            </li>

    

            <li role="presentation" class="dropdown">
              <a href="javascript:;" class="dropdown-toggle info-number" data-toggle="dropdown" aria-expanded="false">
                <i class="fa fa-envelope-o"></i>
                <span class="badge bg-green">Coming Soon...</span>
              </a>
              <ul id="menu1" class="dropdown-menu list-unstyled msg_list" role="menu">
                <li>
                  <a>
                    <span class="image"><img src="images/img.jpg" alt="Profile Image" /></span>
                    <span>
                          <span>John Smith</span>
                    <span class="time">3 mins ago</span>
                    </span>
                    <span class="message">
                          Film festivals used to be do-or-die moments for movie makers. They were where...
                        </span>
                  </a>
                </li>
                <li>
                  <a>
                    <span class="image"><img src="images/img.jpg" alt="Profile Image" /></span>
                    <span>
                          <span>John Smith</span>
                    <span class="time">3 mins ago</span>
                    </span>
                    <span class="message">
                          Film festivals used to be do-or-die moments for movie makers. They were where...
                        </span>
                  </a>
                </li>
                <li>
                  <a>
                    <span class="image"><img src="images/img.jpg" alt="Profile Image" /></span>
                    <span>
                          <span>John Smith</span>
                    <span class="time">3 mins ago</span>
                    </span>
                    <span class="message">
                          Film festivals used to be do-or-die moments for movie makers. They were where...
                        </span>
                  </a>
                </li>
                <li>
                  <a>
                    <span class="image"><img src="images/img.jpg" alt="Profile Image" /></span>
                    <span>
                          <span>John Smith</span>
                    <span class="time">3 mins ago</span>
                    </span>
                    <span class="message">
                          Film festivals used to be do-or-die moments for movie makers. They were where...
                        </span>
                  </a>
                </li>
                <li>
                  <div class="text-center">
                    <a>
                      <strong>See All Alerts</strong>
                      <i class="fa fa-angle-right"></i>
                    </a>
                  </div>
                </li>
              </ul>
            </li>
          </ul>
        </nav>
      </div>
    </div>
    <!-- /top navigation -->
 </div>
    <!-- page content -->



    <div class="right_col" role="main">
        <button id="uploadBtn"><i class="fa fa-plus"></i>Add Sale</button>
        <div class="search-container">
            <input type="date" id="searchInput" placeholder="Search by date...">
            <button id="searchButton"><i class="fas fa-search"></i> </button> 
            <span id="onlineStatus"></span> 
          </div>       
  <span id="totalRevenue" class="outstanding"></span>
  <div id="overlay"></div>




  <div class="chart-container">
    <canvas id="revenue-progress-chart"></canvas>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <div id="loader" class="loader"></div>
        <div id="patients" class="patients-container"></div>
        <!-- Popup Overlay -->
        <div class="popup-overlay" id="popupOverlay1">
          <div class="popup">
            <span class="popup-close" id="popupClose1">&times;</span>
            <h2>Medical Prescriptions</h2>
            <div id="patientHistory"></div>
            <button id="addMedicationBtn"><i class="fa fa-plus"></i>Add Record</button>
          </div>
        </div>
        <!-- Popup Overlay -->
        <div class="popup-overlay" id="addRecordPopupOverlay">
          <div class="popup">
            <span class="popup-close" id="addRecordPopupClose">&times;</span>
            <h2>Add Medication Record</h2>
            <form id="addRecordForm" data-patient-name="">
              <label for="testsTaken">Age Range:</label>
              <input type="age" id="testsTaken" required>
              <label for="resultsObtained">Prescription:</label>
              <input type="text" id="resultsObtained" required>
              <label for="medicationTaken">Works on (Treats):</label>
              <input type="text" id="medicationTaken" required>
              <label for="additionalNotes">Additional Notes:</label>
              <input type="text" id="additionalNotes" required>
              <button type="submit">Submit</button>
            </form>
          </div>
        </div>
        <div class="popup-overlay" id="popupOverlay">
          <div class="popup">
            <span class="popup-close" id="popupClose">&times;</span>
            <h2>Upload Sales Details</h2>
            <form class="popup-form" id="addPatientForm">
              <label for="name">Name of Product:</label>
              <input type="text" id="name" required>
              <label for="dob">Date of Sale:</label>
              <input type="date" id="dob" required>
              <label for="parents">Total Amount :</label>
              <input type="tel" id="parents" required>
              <label for="nos">Quantity:</label>
              <input type="number" id="nos" required>
              <button type="submit">Submit</button>
            </form>
            <div id="message"></div>
          </div>
        </div>
      </div>
      <script>
        var uploadBtn = document.getElementById('uploadBtn');
        var popupOverlay = document.getElementById('popupOverlay');
        var popupClose = document.getElementById('popupClose');
      uploadBtn.addEventListener('click', function() {
      popupOverlay.style.visibility = 'visible';
      popupOverlay.style.opacity = '1';
      });
      
      popupClose.addEventListener('click', function() {
      popupOverlay.style.visibility = 'hidden';
      popupOverlay.style.opacity = '0';
      });
      </script>

    <!-- /page content -->


 <!-- Firebase libraries -->
<script type="module" src="https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/9.0.2/firebase-database.js"></script>

<script type="module" src="progress.js">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js";
  import { getDatabase, ref,remove, push,get, onValue,child,set } from "https://www.gstatic.com/firebasejs/9.0.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCi_hufIZTzsYtdPGQtvtmKmAkkrydmn_A",
  authDomain: "abbah-83a7b.firebaseapp.com",
  databaseURL: "https://abbah-83a7b-default-rtdb.firebaseio.com",
  projectId: "abbah-83a7b",
  storageBucket: "abbah-83a7b.appspot.com",
  messagingSenderId: "379729759051",
  appId: "1:379729759051:web:e75528d61b02d1e4f536ce",
  measurementId: "G-H41J2WMR6S"
  };



  const app = initializeApp(firebaseConfig);
const database = getDatabase(app);
const auth = getAuth(app); // Initialize Firebase Authentication


// Function to display a message with optional retry button and success flag
function displayMessage(title, message, isSuccess = false) {
  // Clear existing messages
  const existingMessages = document.querySelectorAll('.retry-message');
  existingMessages.forEach(function (message) {
    message.remove();
  });

  // Create a div element for the message
  const messageDiv = document.createElement('div');
  messageDiv.classList.add('retry-message'); // Add the class for styling

  // Set background color to green for success message
  if (isSuccess) {
    messageDiv.style.backgroundColor = '#4caf50';
  }

// Create close button element
const closeButton = document.createElement('button');
closeButton.classList.add('close-btn');
closeButton.innerHTML = '<i class="fa fa-times"></i>';
closeButton.addEventListener('click', function () {
  messageDiv.remove();
});


  // Create title element
  const titleElement = document.createElement('h2');
  titleElement.textContent = title;

  // Create message element
  const messageElement = document.createElement('p');
  messageElement.textContent = message;

  // Append title, message, and close button to the message div

  messageDiv.appendChild(titleElement);
  messageDiv.appendChild(messageElement);
  messageDiv.appendChild(closeButton);
  // Append the message div to the document body
  document.body.appendChild(messageDiv);


}


// Rest of your code...
// Display the email sign-in popup on page load
window.addEventListener('load', function() {
  // Check if the user is already signed in
  auth.onAuthStateChanged(function(user) {
    if (user) {
      // User is signed in
      console.log('User signed in:', user.email);
      // Display success message
      displayMessage('Success', `Welcome, ${user.email}! You are authenticated.`, true); // Pass true for success message
      // Reload the page content
      location.reload();
      // Perform any necessary actions for an authenticated user
    } else {
      // User is not signed in, display the sign-in popup
      var provider = new GoogleAuthProvider();
      signInWithPopup(auth, provider)
        .then(function(result) {
          // Handle sign-in success
          var user = result.user;
          console.log('User signed in:', user.email);
          // Display success message
          displayMessage('Success', `Welcome, ${user.email}! You are authenticated.`, true); // Pass true for success message
          // Reload the page content
          location.reload();
          // Perform any necessary actions for an authenticated user
        })
        .catch(function(error) {
          // Handle sign-in error
          console.error('Error signing in:', error);
          // Display access denied message
          displayMessage('Access Denied', 'You are not authenticated. Please sign in with a valid email.');
        });
    }
  });
});

// Function to retry the sign-in process
function retryCallback() {
  var provider = new GoogleAuthProvider();
      signInWithPopup(auth, provider)
          .then(function(result) {
      // Handle sign-in success
      var user = result.user;
      console.log('User signed in:', user.email);
      // Display success message
      displayMessage('Success', `Welcome, ${user.email}! You are authenticated.`, true); // Pass true for success message
      // Reload the page content
      location.reload();
      // Perform any necessary actions for an authenticated user
    })
    .catch(function(error) {
      // Handle sign-in error
      console.error('Error signing in:', error);
    });
}




displayMessage('Signing in...', 'Please wait...', false); // Pass false for error message



// Function to log out
function logOut() {
  auth.signOut()
    .then(function() {
      console.log('User signed out');
      // Display log out message
      displayMessage('Logged Out', 'You have been successfully logged out.');
    })
    .catch(function(error) {
      console.error('Error signing out:', error);
    });
}


  const form = document.querySelector('.popup-form');
const submitButton = document.querySelector('.popup-form button');
const successMessage = document.createElement('p');
successMessage.textContent = 'Revenue details uploaded successfully!';
successMessage.style.color = 'green';
const errorMessage = document.createElement('p');
errorMessage.textContent = 'Error uploading revenue details. Please try again.';
errorMessage.style.color = 'red';
const patientsContainer = document.getElementById('patients');
let patients = []; // Declare patients variable outside the event listener


form.addEventListener('submit', function(e) {
  e.preventDefault();

  const name = document.getElementById('name').value;
  const dob = document.getElementById('dob').value;
  const parents = document.getElementById('parents').value;
  const dos = document.getElementById('nos').value;
  const patientData = {
    name: name,
    dob: dob,
    parents: parents,
    dos:dos
  };

  const patientsRef = ref(database, 'revenue');
  const newPatientRef = child(patientsRef, name); // Use patient name as the key

  set(newPatientRef, patientData)
    .then(() => {
      form.reset();
      form.appendChild(successMessage);
    })
    .catch(() => {
      form.appendChild(errorMessage);
    });
});
searchButton.addEventListener('click', () => {
  const searchTerm = searchInput.value.trim(); // Get the search term

  // Show the loader
  loaderElement.classList.remove('hidden');

  // Clear the patients container
  patientsContainer.innerHTML = '';

  // Search through Firebase for patient names by key
  const patientsRef = ref(database, 'revenue');
  onValue(patientsRef, (snapshot) => {
    const patientsData = snapshot.val();
    const searchResults = [];

    if (patientsData) {
      const patients = Object.values(patientsData);

      if (searchTerm !== '') {
        // Filter patients based on the search term
        patients.forEach(patient => {
          if (patient.dob === searchTerm) {
            searchResults.push(patient);
          }
        });
      } else {
        // Display all patients if the search term is empty
        searchResults.push(...patients);
      }
    }

    // Hide the loader
    loaderElement.classList.add('hidden');

    // Display search results
    if (searchResults.length > 0) {
      renderPatients(searchResults);
    } else {
      patientsContainer.innerHTML = '<p class="no-results">No Revenues found.</p>';
    }
  });
});


// Get the canvas element and create a chart context for Revenue Progress
const canvas1 = document.getElementById('revenue-progress-chart');
const ctx1 = canvas1.getContext('2d');
let revenueProgressChart = null;

// Render the Revenue Progress chart
function renderRevenueProgressChart(patients) {
  // Sort patients by date of birth (dob) in ascending order
  patients.sort((a, b) => new Date(a.dob) - new Date(b.dob));

  // Get the earliest date
  const earliestDate = patients[0].dob;

  // Extract the unique dates of birth starting from the earliest date
  const uniqueDates = [...new Set(patients.map(patient => patient.dob))].filter(date => date >= earliestDate);

  // Calculate the revenue earned on each date of birth
  const revenueEarned = uniqueDates.map(date => {
    const patientsOnDate = patients.filter(patient => patient.dob === date);
    const totalRevenueOnDate = patientsOnDate.reduce((sum, patient) => sum + parseFloat(patient.parents), 0);
    return totalRevenueOnDate;
  });

  // Destroy the previous chart if it exists
  if (revenueProgressChart) {
    revenueProgressChart.destroy();
  }

  // Chart data
  const chartData = {
    labels: uniqueDates,
    datasets: [
      {
        label: 'Revenue Progress. Uganda Shillings, (UGX)',
        data: revenueEarned,
        fill: false,
        borderColor: 'rgba(54, 162, 235, 1)', // Adjust the color as desired
        borderWidth: 1
      }
    ]
  };

  // Chart configuration
  const chartConfig = {
    type: 'line',
    data: chartData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  };

  // Create the chart
  revenueProgressChart = new Chart(ctx1, chartConfig);
}

// Fetch the patients data from the database
const patientsRef = ref(database, 'revenue');
onValue(patientsRef, (snapshot) => {
  const patientsData = snapshot.val();

  if (patientsData) {
    const patients = Object.values(patientsData);

    // Convert the revenue (parents) to numbers
    patients.forEach(patient => {
      patient.parents = parseFloat(patient.parents);
    });


   

    // Call the function to render the revenue progress chart
    renderRevenueProgressChart(patients);
  }
});



// Function to delete a record from the database
function deleteRecord(recordKey, patientName, password) {
  // Prompt the user for confirmation
  const confirmation = confirm('Are you sure you want to delete this record?');

  if (confirmation) {
    // Check if the password is correct
    if (password === 'mm') { // Replace 'your_password' with the actual password
      // Create a reference to the specific record in the patient's history
      const recordRef = ref(database, `revenue/${patientName}`);

      // Remove the record from the database
      remove(recordRef)
        .then(() => {
          alert('Record deleted successfully!');
        })
        .catch((error) => {
          console.error('Error deleting record:', error);
          alert('Error deleting record. Please try again.');
        });
    } else {
      alert('Wrong password. Deletion cancelled.');
    }
  }
}




// Define the addRecordForm and currentPatientName variables
const addRecordForm = document.getElementById('addRecordForm');
let currentPatientName = '';
function showMessage(message) {
  const messageElement = document.getElementById('message');
  messageElement.textContent = message;
  messageElement.style.display = 'block';

  // Hide the message after 4 seconds (4000 milliseconds)
  setTimeout(() => {
    messageElement.style.display = 'none';
  }, 4000);
}

// Call showMessage with an empty message to hide the message on page load
showMessage('');


// Attach the submit event listener outside the function
addRecordForm.addEventListener('submit', function (e) {
  e.preventDefault();

  const patientName = currentPatientName;
  const testsTaken = document.getElementById('testsTaken').value;
  const resultsObtained = document.getElementById('resultsObtained').value;
  const medicationTaken = document.getElementById('medicationTaken').value;
  const additionalNotes = document.getElementById('additionalNotes').value;

  const recordData = {
    testsTaken: testsTaken,
    resultsObtained: resultsObtained,
    medicationTaken: medicationTaken,
    additionalNotes: additionalNotes
  };


  const patientRef = ref(database, `revenue/${patientName}`);
  const newRecordRef = push(child(patientRef, 'history'));
  set(newRecordRef, recordData)
    .then(() => {
      addRecordForm.reset();
      showMessage('Record added successfully!');
    })
    .catch((error) => {
      console.error('Error adding record:', error);
      showMessage('Error adding record. Please try again.');
    });
});

function openPatientHistoryPopup(patient) {
    const popupOverlay = document.getElementById('popupOverlay1');
    const popupClose = document.getElementById('popupClose1');
    const patientHistory = document.getElementById('patientHistory');

    // Clear existing patient history
    patientHistory.innerHTML = '';

    // Populate patient history in the popup
    // You can customize the format and content of the patient history here
    const patientHistoryContent = document.createElement('div');
    patientHistoryContent.innerHTML = `
      <p><strong>Name of Medicine:</strong> ${patient.name}</p>
      <p><strong>Date of Expiry:</strong> ${patient.dob}</p>
      <p><strong>Number of Pieces:</strong> ${patient.parents}</p>
      <p><strong>Date of Stock:</strong> ${patient.dos}</p>
      <p><strong>Medical History:</strong> ${patient.medicalHistory}</p>
    `;
    patientHistory.appendChild(patientHistoryContent);

    // Open the popup
    popupOverlay.style.visibility = 'visible';
    popupOverlay.style.opacity = '1';
// Close the add record popup
  addRecordPopupOverlay.style.visibility = 'hidden';
  addRecordPopupOverlay.style.opacity = '0';

    // Close the popup when the close button is clicked
    popupClose.addEventListener('click', function() {
      popupOverlay.style.visibility = 'hidden';
      popupOverlay.style.opacity = '0';
    });


  

  const patientHistoryElement = document.getElementById('patientHistory');

// Retrieve and display the patient's history
const patientName = patient.name; // Replace this with the patient's name
const patientHistoryRef = ref(database, `revenue/${patientName}/history`);
onValue(patientHistoryRef, (snapshot) => {
  patientHistoryElement.innerHTML = ''; // Clear previous records

  if (snapshot.exists()) {
    snapshot.forEach((childSnapshot) => {
      const recordKey = childSnapshot.key;
      const record = childSnapshot.val();
      const recordElement = createRecordElement(recordKey, record);
      patientHistoryElement.appendChild(recordElement);
    });
  } else {
    const noRecordsElement = document.createElement('p');
    noRecordsElement.textContent = 'No Records Found';
    noRecordsElement.style.fontStyle = 'italic';
    patientHistoryElement.appendChild(noRecordsElement);
  }
});

  
// Function to create a record element
function createRecordElement(recordKey, record) {
  const recordElement = document.createElement('div');
  recordElement.classList.add('record');

  const recordKeyElement = document.createElement('h4');
  recordKeyElement.textContent = 'Record Key: ' + recordKey;
  recordElement.appendChild(recordKeyElement);

  const testsTakenElement = document.createElement('p');
  testsTakenElement.textContent = 'Age Range: ' + record.testsTaken;
  recordElement.appendChild(testsTakenElement);

  const resultsObtainedElement = document.createElement('p');
  resultsObtainedElement.textContent = 'Prescription: ' + record.resultsObtained;
  recordElement.appendChild(resultsObtainedElement);

  const medicationTakenElement = document.createElement('p');
  medicationTakenElement.textContent = 'Works on (Treats): ' + record.medicationTaken;
  recordElement.appendChild(medicationTakenElement);

  const additionalNotesElement = document.createElement('p');
  additionalNotesElement.textContent = 'Additional Notes: ' + record.additionalNotes;
  recordElement.appendChild(additionalNotesElement);

  // Create delete button
const deleteButton = document.createElement('button');
deleteButton.classList.add('delete-button');

// Create bin icon
const binIcon = document.createElement('i');
binIcon.classList.add('fa', 'fa-trash');

// Set the inner HTML of the delete button
deleteButton.innerHTML = '';
deleteButton.appendChild(binIcon);
deleteButton.innerHTML += ' Delete';


  // Add click event listener to delete the record
  deleteButton.addEventListener('click', () => {
    deleteRecord(recordKey);
  });

  // Append the delete button to the record element
  recordElement.appendChild(deleteButton);

  return recordElement;
}
// Function to delete a record from the database
function deleteRecord(recordKey) {
  const patientName = patient.name; // Replace this with the patient's name

  // Prompt the user for confirmation
  const confirmation = confirm('Are you sure you want to delete this record?');

  if (confirmation) {
    // Prompt the user for password
    const password = prompt('Please enter your password to confirm the deletion:');
    
    // Check if the password is correct
    if (password === 'mm') { // Replace 'your_password' with the actual password
      // Create a reference to the specific record in the patient's history
      const recordRef = ref(database, `revenue/${patientName}/history/${recordKey}`);

      // Remove the record from the database
      remove(recordRef)
        .then(() => {
          alert('Record deleted successfully!');
        })
        .catch((error) => {
          console.error('Error deleting record:', error);
          alert('Error deleting record. Please try again.');
        });
    } else {
      alert('Wrong password. Deletion cancelled.');
    }
  }
}
  
  };





// Open the add record popup
const addMedicationBtn = document.getElementById('addMedicationBtn');
const addRecordPopupOverlay = document.getElementById('addRecordPopupOverlay');
const addRecordPopupClose = document.getElementById('addRecordPopupClose');

addMedicationBtn.addEventListener('click', () => {
  addRecordPopupOverlay.style.visibility = 'visible';
  addRecordPopupOverlay.style.opacity = '1';
});

// Close the add record popup
addRecordPopupClose.addEventListener('click', () => {
  addRecordPopupOverlay.style.visibility = 'hidden';
  addRecordPopupOverlay.style.opacity = '0';
});


const loaderElement = document.getElementById('loader');


// Show the loader
loaderElement.classList.remove('hidden');

onValue(patientsRef, (snapshot) => {
  const patientsData = snapshot.val();


  // Hide the loader
  loaderElement.classList.add('hidden');
});

const uploadForm = document.getElementById('addPatientForm');
uploadForm.addEventListener('submit', (e) => {
  e.preventDefault();

// Assuming you have already initialized Firebase
const nameInput = document.getElementById('name');
const dobInput = document.getElementById('dob');
const parentsInput = document.getElementById('parents');

const database = getDatabase();

// Save patient data to Firebase
const savePatientData = () => {
  const name = nameInput.value;
  const dob = dobInput.value;
  const parents = parentsInput.value;

  const patientsRef = ref(database, 'revenue');
  const newPatientRef = child(patientsRef, name); // Use patient name as the key

  set(newPatientRef, {
    name: name,
    dob: dob,
    parents: parents
  })
    .then(() => {
      nameInput.value = '';
      dobInput.value = '';
      parentsInput.value = '';

      showMessage('Patient details uploaded successfully!');
    })
    .catch((error) => {
      console.error('Error uploading patient details:', error);
      showMessage('Error uploading patient details. Please try again.');
    });
};

const showMessage = (message) => {
  const messageElement = document.getElementById('message');
  messageElement.textContent = message;
  messageElement.style.display = 'block';

  setTimeout(() => {
    messageElement.style.display = 'none';
  }, 3000);
};



});

// Get the online status element
const onlineStatusElement = document.getElementById('onlineStatus');
const overlayElement = document.getElementById('overlay');

// Function to update the online status indicator
function updateOnlineStatus() {
  if (navigator.onLine) {
    onlineStatusElement.innerHTML = '<i class="fa fa-wifi"></i> System Online';
    onlineStatusElement.classList.remove('offline');
    onlineStatusElement.classList.add('online');
    overlayElement.style.display = 'none';
  } else {
    onlineStatusElement.innerHTML = '<i class="fa fa-exclamation-triangle"></i> System Offline';
    onlineStatusElement.classList.remove('online');
    onlineStatusElement.classList.add('offline');
    overlayElement.style.display = 'block';
  }
}

// Initial update of online status
updateOnlineStatus();

// Add event listeners for online and offline events
window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

</script>


  </body>
<!-- partial -->
  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js'></script><script  src="./portal.js"></script>

</body>
</html>
